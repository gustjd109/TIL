# 03 네트워크 계층

## 1. 데이터 링크 계층의 한계
1. 물리 계층과 데이터 링크 계층만으로는 다른 네트워크까지의 도달 경로를 파악하기 어려움
    - 서로 멀리 떨어진 호스트들이 정보를 주고받는다면, 해당 패킷은 서로에게 도달하기 위해 수많은 네트워크 장비를 거치며, 다양한 경로를 통해 이동해야 함
    - 서로 통신을 빠르게 주고받으려면 최적의 경로로 패킷이 이동해야 함
    - 물리, 데이터 링크 계층에는 라우팅을 수행할 수 있는 장비가 없지만, 네트워크 계층에는 라우팅을 수행하는 장비인 라우터가 존재<br><br>

2. MAC 주소만으로는 모든 네트워크에 속한 호스트의 위치를 특정하기 어려움
    - MAC 주소만으로는 이 세상의 모든 호스트를 특정하기 어려움
    - 네트워크에서는 수신인 역할을 하는 정보인 MAC 주소와 수신지 역할을 하는 정보인 IP 주소를 함계 활용하고 IP 주소를 우선으로 고려<br><br>

## 2. 인터넷 프로토콜(IP, Internet Protocol)
1. IP 주소란
    - 논리 주소
    - DHCP(Dynamic Host Configuration Protocol)라는 특정 프로토콜을 통해 자동으로 할당받거나 사용자가 호스트에 직접 할당이 가능
    - 한 호스트가 복수의 IP 주소를 보유하는 것이 가능<br><br>

2. IP 주소 형태
    - 4바이트로 표현할 수 있고, 숫자당 8비트로 표현되기에 0 ~ 255 범위 안에 있는 네 개의 10진수로 표기
    - 각 10진수는 점(.)으로 구분
        - 옥텟(octet) : 점으로 구분된 8비트(0 ~ 255 범위의 10진수)
    - IP 주소 예 : 192.168.1.1<br><br>

3. IP의 기능
    - IP 주소 지정(IP addressing)
        - IP 주소를 바탕으로 송수신 대상을 지정하는 것
    - IP 단편화(IP fragmentation)
        - 전송하고자 하는 패킷의 크기가 MTU라는 최대 전송 단위보다 클 경우, 이를 MTU 크기 이하의 복수의 패킷으로 나누는 것
            - MTU(Maximum Transmission Unit) : 한 번에 전송 가능한 IP 패킷의 최대 크기, 일반적인 크기는 1,500바이트이며 MTU 크기 이하로 나누어진 패킷은 수신지에 도착하면 다시 재조합됨<br><br>

4. IP 버전
    - IPv4
        - IPv4 패킷은 프레임의 페이로드로 데이터 필드에 명시
        - IPv4 패킷 형식
            - (버전, 헤더 길이, 서비스 유형, 패킷 길이, 식별자, 플래그, 단편화 오프셋, TTL, 프로토콜, 헤더 체크섬, 송수신지 IP 주소, 옵션, 패딩)헤더 + (데이터)페이로드
                - 옵션과 패딩 필드는 필요한 경우에 사용
                - IP 단편화 기능에 관여하는 필드 : 식별자, 플래그, 단편화 오프셋 / IP 주소 지정 기능에 관여하는 필드 : 송수신지 IP 주소
                - 헤더 길이가 가변적
        - IPv4 패킷 핵심 필드
            - 식별자(identifier)
                - 패킷에 할당된 번호를 표시하는 필드
                - 잘게 쪼개져서 수신지에 도착한 IPv4 패킷들이 어떤 메시지로부터 쪼개졌는지를 인식하기 위해 사용
            - 플래그(flag)
                - 세 개의 비트로 구성된 필드
                    - 미사용 비트 : 항상 0으로 설정
                    - DF(Don't Fragment) 비트 : 1이라면 IP 단편화를 수행하지 않고, 0이라면 IP 단편화가 가능
                    - MF(More Fragment) : 0이라면 이 패킷이 마지막 패킷임을 의미하고, 1이라면 쪼개진 패킷이 더 있다는 의미
            - 단편화 오프셋(fragment offset)
                - 패킷이 단편화되기 전에 패킷의 초기 데이터에서 몇 번째로 떨어진 패킷인지를 나타내는 필드
                - 단편화되어 전송되는 패킷들은 수신지에 순서대로 도착하지 않을 수 있으며, 수신지가 패킷들을 순서대로 재조합하기 위해 단편화된 패킷이 초기 데이터에서 몇 번째 데이터에 해당하는 패킷인지 판단하기 위해 활용
            - TTL(Time To Live)
                - 패킷의 수명을 의미하며, 무의미한 패킷이 네트워크상에 지속적으로 남아있는 것을 방지하기 위해 존재하는 필도
                - 패킷이 호스트 또는 라우터에 한 번 전달되는 것을 홉(Hop)이라고 하며, TTL 필드의 값은 홉마다 1씩 감소
                - TTL 필드가 0이 되면 해당 패킷은 폐기되고, ICMP 프로토콜을 통해 패킷을 송신한 호스트에게 시간 초과 메시지가 전송됨
            - 프로토콜(Protocol)
                - 상위 계층의 프로토콜이 무엇인지를 나타내는 필드
            - 송수신지 IP 주소(Source or Destination IP Address)
                - 송수신지의 IPv4 주소를 알 수 있는 필드
                - IP 주소 지정이 가능<br><br>

    - IPv6
        - 이론적으로 할당 가능한 IPv4 주소는 총 2³²개로 약 43억 개이지만, IP 주소를 가질 수 있는 장치가 여러 개인 것으로 봤을 때 전 세계 인구가 하나씩 IP 주소를 가지고 있어도 부족한 개수라는 이유에서 등장
        - 16바이트로 주소를 표현할 수 있고, 콜론(:)으로 구분된 8개 그룹의 16진수로 표기
        - 할당 가능한 주소는 이론적으로 2¹²⁸개로 사실상 무한에 가까운 개수 할당이 가능
        - IPv6 주소 예 : 2001:0230:abcd:ffff:0000:0000:ffff:1111
        - IPv6 패킷 형식
            - (버전, 트래픽 클래스, 흐름 라벨, 페이로드 길이, 다음 헤더, 홉 제한, 송수신지 IP 주소)헤더 + (데이터)페이로드
                - IPv4에 비해 간소화되어 있으며, 추가적인 헤더 정보가 필요한 경우 기본 헤더와 더불어 확장 헤더 보유가 가능
                    - 확장 헤더(extension header)
                        - 기본 헤더와 페이로드 데이터 사이에 위치
                        - 대표적인 확장 헤더 종류
                            - 홉 간 옵션(Hop-by-Hop Options) : 송신지에서 수신지에 이르는 모든 경로의 네트워크 장비가 패킷을 검사하도록 하는 확장 헤더
                            - 수신지 옵션(Destination Options) : 수신지에서만 패킷을 검사하도록 하는 확장 헤더
                            - 라우팅(Routing) : 라우팅 관련 정보를 운반하는 확장 헤더
                            - 단편화(Fragment) : 단편화를 위한 확장 헤더
                            - ESP(Encapsulation Security Payload), AH(Authentication Header) : 암호화 인증을 위한 확장 헤더
                - 기본 헤더는 40바이트로 고정적
        - IPv6 패킷 핵심 필드
            - 다음 헤더(netx header)
                - 상위 계층의 프로토콜을 가리키거나 확장 헤더를 가리키는 필드
            - 홉 제한(hop limit)
                - 패킷의 수명을 나타내는 필드
            - 송수신지 IP 주소(Source or Destination IP Address)
                - 송수신지의 IPv6 주소를 알 수 있는 필드
                - IP 주소 지정이 가능<br><br>

## 3. ARP(Address Resolution Protocol)
1. ARP란
    - 동일 네트워크 내에 있는 상대 호스트의 IP 주소는 알지만, MAC 주소는 알지 못하는 상황에서 상대 호스트 IP 주소를 통해 MAC 주소를 알아내기 위해 사용하는 프로토콜<br><br>

2. 동일 네트워크 내에 있는 호스트 A가 호스트 B의 MAC 주소를 알아내기 위한 ARP 동작 과정
    - ARP 요청(ARP Request)
        - A는 네트워크 내의 모든 호스트에게 브로드캐스트 메시지를 전송 = ARP 패킷 전송
            - 'B의 IP 주소'와 통신하고 싶은데, B의 MAC 주소가 무엇인지 소리치는 것과 동일
    - ARP 응답(ARP Reply)
        - B를 제외한 나머지 호스트는 자신의 IP가 아니므로 ARP 요청을 무시
        - B는 자신의 MAC 주소를 담은 유니캐스트 메시지를 A에게 전송 = ARP 패킷 전송
    - ARP 테이블 갱신
        - ARP를 활용할 수 있는 모든 호스트는 ARP 테이블이라는 정보를 유지
            - ARP 테이블
                - IP 주소와 그에 맞는 MAC 주소 테이블을 대응하는 표
                - 일정 시간이 지나면 삭제되고, 임의로 삭제가 가능<br><br>

## 4. IP 단편화를 피하는 방법
1. IP 단편화는 되도록 하지 않는 것이 좋음
    - 데이터가 여러 패킷으로 쪼개지면 자연스레 전송해야 할 패킷의 헤더들이 증가 → 불필요한 트래픽 증가와 대역폭 낭비
    - 쪼개진 IP 패킷들을 하나로 합치는 과정에서 발생하는 부하가 증가 → 성능 저하<br><br>

2. IP 단편화를 피하는 방법
    - IP 패킷을 주고받는 모든 호스트의 '처리 가능한 MTU 크기'를 고려하여 '경로 MTU'만큼의 데이터를 전송하는 것
        - 호스트 A, B가 여러 라우터를 거쳐 서로 IP 패킷을 주고받는다고 가정
        - 호스트 A, B가 처리할 수 있는 MTU 크기가 우무리 커도 라우터가 해당 MTU 크기를 지원하지 않으면 IP 단편화를 해야 함
        - 즉, IP 단편화를 피하려면 'IP 단편화 없이 주고받을 수 있는 최대 크기'만큼만 전송해야 함 → 이 크기를 경로 MTU(Path MTU)라고 함<br><br>

3. 경로 MTU 발견(Path MTU discovery)
    - 경로 MTU를 구하고 해당 크기만큼만 송수신하여 IP 단편화를 회피하는 기술
    - 오늘날 네트워크그에서는 대부분 이를 지우너하고, 처리 가능한 최대 MTU 크기도 대부분 균일하여 IP 단편화는 자주 수행되지 않음<br><br>

## 5. IP 주소 세부 내용
1. 네트워크 주소와 호스트 주소
    - 네트워크 주소 : 네트워크 ID, 네트워크 식별자 등으로 불림
    - 호스트 주소 : 호스트 ID, 호스트 식별자 등으로 불림<br><br>

2. 네트워크 주소와 호스트 주소의 형태
    - 172.16.12.45(172, 16 : 네트워크 주소 / 12, 45 : 호스트 주소) = 10101100.00010000.00001100.00101101
    - IP 주소에서 네트워크 주소와 호스트 주소를 구분하는 범위는 유동적으로 가능
        - 호스트 주소 공간을 크게 할당하면, 호스트가 할당되지 않은 다수의 IP 주소가 낭비
        - 호스트 주소 공간을 작게 할당하면, 호스트가 사용할 IP 주소가 부족<br><br>

3. 클래스
    - 클래스란
        - 네트워크 크기에 따라 IP 주소를 분류하는 기준
        - 필요한 호스트 IP 개수에 따라 네트워크 크기를 가변적으로 조정해 네트워크 주소와 호스트 주소 구획이 가능
    - 클래스 종류
        - 클래스풀 주소 체계(classful addressing)
            - 클래스를 기반으로 IP 주소를 관리하는 주소 체계
            - 클래스 표
                - 할당 가능한 호스트 수에서 2를 뺀 이유
                    - 호스트 주소가 전부 0인 주소는 해당 네트워크 자체를 의미하는 네트워크 주소로 사용되고, 전부 1인 주소는 브로드캐스트를 위한 주소로 사용되기 때문에 제외
            - 클래스풀 주소 체계를 이용하면 네트워크 영역을 결정하고 할당 가능한 호스트의 주소 공간을 유동적으로 관리가 가능
            - 단, 클래스별 네트워크의 크기가 고정되어 있기에 다수의 IP 주소가 낭비될 가능성이 크다는 문제가 존재
        - 클래스리스 주소 체계(classless addressing)
            - 클래스 개념 없이 클래스에 구애받지 않고 네트워크의 영역을 나누어서 호스트에게 IP 주소 공간을 할당하는 방식
            - 서브넷 마스크를 이용해 네트워크 주소와 호스트 주소를 구분하는 IP 주소 체계<br><br>

4. 서브넷 마스크
    - 클래스리스 주소 체계에서 네트워크와 호스트를 구분 짓는 수단으로 이용
    - IP 주소상에서 네트워크 주소는 1, 호스트 주소는 0으로 표기한 비트열 = 네트워크 내의 부분적인 네트워크(서브네트워크)를 구분 짓는(마스크) 비트열<br><br>

5. 서브네팅
    - 서브넷 마스크를 이용해 클래스를 원하는 크기로 더 잘게 쪼개어 사용하는 것
    - 클래스풀 주소 체계에서 각 클래스의 기본 서브넷 마스크
        - A 클래스 : 255.0.0.0(11111111.00000000.00000000.00000000)
        - B 클래스 : 255.255.0.0(11111111.11111111.00000000.00000000)
        - C 클래스 : 255.255.255.0(11111111.11111111.11111111.00000000)<br><br>

6. 서브네팅 : 비트 AND 연산
    - 서브넷 마스크를 이용해 네트워크 주소와 호스트 주소를 구분 짓는 방법
    - 서브넷 마스크 간의 비트 AND 연산을 수행하면 IP 주소 내의 네트워크 주소를 알아낼 수 있음<br><br>

7. 서브넷 마스크 표기 : CIDR(Classless Inter-Domain Routing notion) 표기법
    - 'IP 주소/서브넷 마스크상의 1의 개수' 형식으로 표기하는 방법
    - 예를 들어 C 클래스 서브넷 마스크를 2진수로 표기하면 1의 개수가 24개이므로, '/24'로 표기가 가능<br><br>

## 6. 공긴 IP 주소와 사설 IP 주소
1. 공인 IP 주소
    - 전 세계에서 고유한 IP 주소(= 인터넷을 이용할 때 사용하는 IP 주소)
    - ISP나 공인 IP 주소 할당 기관을 통해 할당받기가 가능<br><br>

2. 사설 IP 주소
    - 사설 네트워크에서 사용하기 위한 IP 주소
        - 사설 네트워크 : 인터넷, 외부 네트워크에 공개되지 않은 네트워크(우리가 사용하는 모든 네트워크 기기의 IP 주소)
    - 사설 IP 주소의 할당 주체는 라우터
    - 할당받은 사설 IP 주소는 해당 호스트가 속한 사설 네트워크상에서만 유효한 주소이므로, 얼마든지 다른 네트워크상의 사설 IP 주소와 중복이 가능<br><br>

3. NAT(Network Address Translation)
    - 사설 IP 주소를 사용하는 호스트가 외부 네트워크와 통신하기 위해 사용되는 기술
    - 네트워크 내부에서 사용된는 사설 IP 주소와 네트워크 외부에서 사용되는 공인 IP 주소를 변환하는 데 사용되는 기술<br><br>

## 7. 호스트에 IP 주소 할당 방법
1. 정적 할당
    - 호스트에 직업 수작업으로 IP 주소를 부여하는 방식<br><br>

2. 동적 할당
    - 정적 할당과 달리 IP 주소를 직접 일일이 입력하지 않아도 호스트에 IP 주소가 동적으로 할당되는 방식
    - 사용되지 않을 경우 회수되고, 할당받을 때마다 다른 주소를 할당받음<br><br>

3. DHCP(Dynamic Host Configuration Protocol)
    - IP 동적 할당에 사용되는 대표적인 프로토콜
    - IP 주소 할당을 IP 주소를 할당받고자 하는 호스트(클라이언트)와 해당 호스트에게 IP 주소를 제공하는 DHCP 서버 간의 메시지를 주고받음으로써 이루어짐
    - DHCP로 할당받은 IP 주소는 사용할 기간(임대 기간)이 정해져 있음