# 03 네트워크 계층

## 1. 데이터 링크 계층의 한계
1. 물리 계층과 데이터 링크 계층만으로는 다른 네트워크까지의 도달 경로를 파악하기 어려움
    - 서로 멀리 떨어진 호스트들이 정보를 주고받을 경우 해당 패킷은 서로에게 도달하기 위해 수많은 네트워크 장비를 거치며, 다양한 경로를 통해 이동해야 함
    - 서로 통신을 빠르게 주고받기 위해 최적의 경로로 패킷이 이동해야 함
    - 물리, 데이터 링크 계층에는 최적의 경로로 패킷을 이동시키는 라우팅 기능을 수행할 수 있는 장비가 없지만, 네트워크 계층에는 라우팅을 수행하는 장비인 라우터가 존재<br><br>

2. MAC 주소만으로는 모든 네트워크에 속한 호스트의 위치를 특정하기 어려움
    - MAC 주소만으로는 이 세상의 모든 호스트를 특정하기 어려움
    - 네트워크에서는 수신인 역할을 하는 정보인 MAC 주소와 수신지 역할을 하는 정보인 IP 주소를 함께 활용하고 IP 주소를 우선으로 고려함<br><br>

## 2. 인터넷 프로토콜(IP, Internet Protocol)
1. IP 주소란
    - 논리 주소
    - DHCP(Dynamic Host Configuration Protocol)라는 특정 프로토콜을 통해 자동으로 할당받거나 사용자가 호스트에 직접 할당 가능
    - 한 호스트가 복수의 IP 주소 보유가 가능<br><br>

2. IP 주소 형태
    - 4바이트로 표현할 수 있고, 숫자당 8비트로 표현되기에 0 ~ 255 범위 안에 있는 네 개의 10진수로 표기
    - 각 10진수는 점(.)으로 구분
        - 옥텟(octet) : 점으로 구분된 8비트(0 ~ 255 범위의 10진수)
    - IP 주소 예 : 192.168.1.1<br><br>

3. IP의 기능
    - IP 주소 지정(IP addressing)
        - 지정된 IP 주소를 바탕으로 송수신 대상을 지정
    - IP 단편화(IP fragmentation)
        - 전송하고자 하는 패킷의 크기가 MTU라는 최대 전송 단위보다 클 경우, 이를 MTU 크기 이하의 복수의 패킷으로 나눔
            - MTU(Maximum Transmission Unit)
                - 한 번에 전송 가능한 IP 패킷의 최대 크기로, 일반적인 크기는 1,500바이트이며 MTU 크기 이하로 나누어진 패킷은 수신지에 도착하면 다시 재조합됨<br><br>

4. IP 버전
    - IPv4
        - IPv4 패킷은 프레임의 페이로드로 데이터 필드에 명시
        - IPv4 패킷 형식
            - (버전, 헤더 길이, 서비스 유형, 패킷 길이, 식별자, 플래그, 단편화 오프셋, TTL, 프로토콜, 헤더 체크섬, 송수신지 IP 주소, 옵션, 패딩)헤더 + (데이터)페이로드
                - 옵션과 패딩 필드는 필요한 경우에 사용
                - IP 단편화 기능에 관여하는 필드 : 식별자, 플래그, 단편화 오프셋
                - IP 주소 지정 기능에 관여하는 필드 : 송수신지 IP 주소
                - 헤더 길이가 가변적
        - IPv4 패킷 핵심 필드
            - 식별자(identifier)
                - 패킷에 할당된 번호를 표시하는 필드
                - 잘게 쪼개져서 수신지에 도착한 IPv4 패킷들이 어떤 메시지로부터 쪼개졌는지를 인식하기 위해 사용
            - 플래그(flag)
                - 세 개의 비트로 구성된 필드
                    - 미사용 비트 : 항상 0으로 설정
                    - DF(Don't Fragment) 비트 : 1이라면 IP 단편화를 수행하지 않고, 0이라면 IP 단편화가 가능
                    - MF(More Fragment) : 0이라면 이 패킷이 마지막 패킷임을 의미하고, 1이라면 쪼개진 패킷이 더 있다는 의미
            - 단편화 오프셋(fragment offset)
                - 패킷이 단편화되기 전에 패킷의 초기 데이터에서 몇 번째로 떨어진 패킷인지를 나타내는 필드
                - 단편화되어 전송되는 패킷들은 수신지에 순서대로 도착하지 않을 수 있어, 수신지가 패킷들을 순서대로 재조합하기 위해 단편화된 패킷이 초기 데이터에서 몇 번째 데이터에 해당하는 패킷인지 판단하기 위해 활용
            - TTL(Time To Live)
                - 패킷의 수명을 의미하며, 무의미한 패킷이 네트워크상에 지속적으로 남아있는 것을 방지하기 위해 존재하는 필드
                - 패킷이 호스트 또는 라우터에 한 번 전달되는 것을 홉(Hop)이라고 하며, TTL 필드의 값은 홉마다 1씩 감소
                - TTL 필드가 0이 되면 해당 패킷은 폐기되고, ICMP 프로토콜을 통해 패킷을 송신한 호스트에게 시간 초과 메시지가 전송됨
            - 프로토콜(Protocol)
                - 상위 계층의 프로토콜이 무엇인지를 나타내는 필드
            - 송수신지 IP 주소(Source or Destination IP Address)
                - 송수신지의 IPv4 주소를 알 수 있는 필드
                - IP 주소 지정이 가능<br><br>

    - IPv6
        - 이론적으로 할당 가능한 IPv4 주소는 총 2³²개로 약 43억 개이지만, IP 주소를 가질 수 있는 장치가 여러 개인 것으로 봤을 때 전 세계 인구가 하나씩 IP 주소를 가지고 있어도 부족한 개수라는 이유에서 등장함
        - 16바이트로 주소를 표현할 수 있고, 콜론(:)으로 구분된 8개 그룹의 16진수로 표기
        - 할당 가능한 주소는 이론적으로 2¹²⁸개로 사실상 무한에 가까운 개수 할당이 가능
        - IPv6 주소 예 : 2001:0230:abcd:ffff:0000:0000:ffff:1111
        - IPv6 패킷 형식
            - (버전, 트래픽 클래스, 흐름 라벨, 페이로드 길이, 다음 헤더, 홉 제한, 송수신지 IP 주소)헤더 + (데이터)페이로드
                - IPv4에 비해 간소화되어 있으며, 추가적인 헤더 정보가 필요한 경우 기본 헤더와 더불어 확장 헤더 보유가 가능
                    - 확장 헤더(extension header)
                        - 기본 헤더와 페이로드 데이터 사이에 위치
                        - 대표적인 확장 헤더 종류
                            - 홉 간 옵션(Hop-by-Hop Options) : 송신지에서 수신지에 이르는 모든 경로의 네트워크 장비가 패킷을 검사하도록 하는 확장 헤더
                            - 수신지 옵션(Destination Options) : 수신지에서만 패킷을 검사하도록 하는 확장 헤더
                            - 라우팅(Routing) : 라우팅 관련 정보를 운반하는 확장 헤더
                            - 단편화(Fragment) : 단편화를 위한 확장 헤더
                            - ESP(Encapsulation Security Payload), AH(Authentication Header) : 암호화 인증을 위한 확장 헤더
                - 기본 헤더는 40바이트로 고정적
        - IPv6 패킷 핵심 필드
            - 다음 헤더(netx header) : 상위 계층의 프로토콜을 가리키거나 확장 헤더를 가리키는 필드
            - 홉 제한(hop limit) : 패킷의 수명을 나타내는 필드
            - 송수신지 IP 주소(Source or Destination IP Address) : 송수신지의 IPv6 주소를 알 수 있는 필드로, IP 주소 지정이 가능<br><br>

## 3. ARP(Address Resolution Protocol)
1. ARP란
    - 동일 네트워크 내에 있는 상대 호스트의 IP 주소는 알지만, MAC 주소는 알지 못하는 상황에서 상대 호스트 IP 주소를 통해 MAC 주소를 알아내기 위해 사용하는 프로토콜<br><br>

2. 동일 네트워크 내에 있는 호스트 A가 호스트 B의 MAC 주소를 알아내기 위한 ARP 동작 과정
    - ARP 요청(ARP Request)
        - A는 네트워크 내의 모든 호스트에게 브로드캐스트 메시지를 전송 = ARP 패킷 전송
        - 'B의 IP 주소'와 통신하고 싶은데, B의 MAC 주소가 무엇인지 소리치는 것과 동일
    - ARP 응답(ARP Reply)
        - B를 제외한 나머지 호스트는 자신의 IP가 아니므로 ARP 요청을 무시
        - B는 자신의 MAC 주소를 담은 유니캐스트 메시지를 A에게 전송 = ARP 패킷 전송
    - ARP 테이블 갱신
        - ARP를 활용할 수 있는 모든 호스트는 ARP 테이블이라는 정보를 유지
            - ARP 테이블 : IP 주소와 그에 맞는 MAC 주소 테이블을 대응하는 표로, 일정 시간이 지나면 삭제되고 임의로 삭제가 가능<br><br>

## 4. IP 단편화를 피하는 방법
1. IP 단편화는 되도록 하지 않는 것이 좋음
    - 데이터가 여러 패킷으로 쪼개지면 자연스레 전송해야 할 패킷의 헤더들이 증가 → 불필요한 트래픽 증가와 대역폭 낭비
    - 쪼개진 IP 패킷들을 하나로 합치는 과정에서 발생하는 부하가 증가 → 성능 저하<br><br>

2. IP 단편화를 피하는 방법
    - IP 패킷을 주고받는 모든 호스트의 '처리 가능한 MTU 크기'를 고려하여 '경로 MTU'만큼의 데이터를 전송
        - 호스트 A, B가 여러 라우터를 거쳐 서로 IP 패킷을 주고받는다고 가정
        - 호스트 A, B가 처리할 수 있는 MTU 크기가 아무리 커도 라우터가 해당 MTU 크기를 지원하지 않으면 IP 단편화를 해야 함
        - 즉, IP 단편화를 피하려면 'IP 단편화 없이 주고받을 수 있는 최대 크기'만큼만 전송해야 함 → 이 크기를 경로 MTU(Path MTU)라고 함<br><br>

3. 경로 MTU 발견(Path MTU discovery)
    - 경로 MTU를 구하고 해당 크기만큼만 송수신하여 IP 단편화를 회피하는 기술
    - 오늘날 네트워크에서는 대부분 이를 지원하고, 처리 가능한 최대 MTU 크기도 대부분 균일하여 IP 단편화는 자주 수행되지 않음<br><br>

## 5. IP 주소 세부 내용
1. 네트워크 주소와 호스트 주소
    - 네트워크 주소 : 네트워크 ID, 네트워크 식별자 등으로 불림
    - 호스트 주소 : 호스트 ID, 호스트 식별자 등으로 불림<br><br>

2. 네트워크 주소와 호스트 주소의 형태
    - 172.16.12.45(172, 16 : 네트워크 주소 / 12, 45 : 호스트 주소) = 10101100.00010000.00001100.00101101
    - IP 주소에서 네트워크 주소와 호스트 주소를 구분하는 범위는 유동적으로 가능
        - 호스트 주소 공간을 크게 할당하면, 호스트가 할당되지 않은 다수의 IP 주소가 낭비됨
        - 호스트 주소 공간을 작게 할당하면, 호스트가 사용할 IP 주소가 부족하게 됨<br><br>

3. 클래스
    - 클래스란
        - 네트워크 크기에 따라 IP 주소를 분류하는 기준
        - 필요한 호스트 IP 개수에 따라 네트워크 크기를 가변적으로 조정해 네트워크 주소와 호스트 주소 구획이 가능
    - 클래스 종류
        - 클래스풀 주소 체계(classful addressing)
            - 클래스를 기반으로 IP 주소를 관리하는 주소 체계
            - 클래스 표
                |클래스|초기 비트|네트워크 주소 비트/호스트 주소 비트|할당 가능한 네트워크 수|할당 가능한 호스트 수|
                |---|---|---|---|---|
                |A|0|8/24|2⁷(128)|2²⁴(16,777,216) - 2|
                |B|10|16/16|2¹⁴(16,384)|2¹⁶(65,536) - 2|
                |C|110|24/8|2²¹(2,097,152)|2⁸(256) - 2|
                -  호스트 주소가 전부 0인 주소는 해당 네트워크 자체를 의미하는 네트워크 주소로 사용되고, 전부 1인 주소는 브로드캐스트를 위한 주소로 사용되기 때문에 할당 가능한 호스트 수에서 2를 제외
            - 클래스풀 주소 체계를 이용하면 네트워크 영역을 결정하고 할당 가능한 호스트의 주소 공간을 유동적으로 관리가 가능
            - 단, 클래스별 네트워크의 크기가 고정되어 있기에 다수의 IP 주소가 낭비될 가능성이 크다는 문제가 존재
        - 클래스리스 주소 체계(classless addressing)
            - 클래스 개념 없이 클래스에 구애받지 않고 네트워크의 영역을 나누어서 호스트에게 IP 주소 공간을 할당하는 방식
            - 서브넷 마스크를 이용해 네트워크 주소와 호스트 주소를 구분하는 IP 주소 체계<br><br>

4. 서브넷 마스크
    - 클래스리스 주소 체계에서 네트워크와 호스트를 구분 짓는 수단으로 이용
    - IP 주소상에서 네트워크 주소는 1, 호스트 주소는 0으로 표기한 비트열 = 네트워크 내의 부분적인 네트워크(서브네트워크)를 구분 짓는(마스크) 비트열<br><br>

5. 서브네팅
    - 서브넷 마스크를 이용해 클래스를 원하는 크기로 더 잘게 쪼개어 사용하는 것
    - 클래스풀 주소 체계에서 각 클래스의 기본 서브넷 마스크
        - A 클래스 : 255.0.0.0(11111111.00000000.00000000.00000000)
        - B 클래스 : 255.255.0.0(11111111.11111111.00000000.00000000)
        - C 클래스 : 255.255.255.0(11111111.11111111.11111111.00000000)<br><br>

6. 서브네팅 : 비트 AND 연산
    - 서브넷 마스크를 이용해 네트워크 주소와 호스트 주소를 구분 짓는 방법
    - 서브넷 마스크 간의 비트 AND 연산을 수행하면 IP 주소 내의 네트워크 주소를 알아낼 수 있음<br><br>

7. 서브넷 마스크 표기 : CIDR(Classless Inter-Domain Routing notion) 표기법
    - 'IP 주소/서브넷 마스크상의 1의 개수' 형식으로 표기하는 방법
    - 예를 들어 C 클래스 서브넷 마스크를 2진수로 표기하면 1의 개수가 24개이므로, '/24'로 표기가 가능<br><br>

## 6. 공긴 IP 주소와 사설 IP 주소
1. 공인 IP 주소
    - 전 세계에서 고유한 IP 주소(= 인터넷을 이용할 때 사용하는 IP 주소)
    - ISP나 공인 IP 주소 할당 기관을 통해 할당받기가 가능<br><br>

2. 사설 IP 주소
    - 사설 네트워크에서 사용하기 위한 IP 주소
        - 사설 네트워크 : 인터넷, 외부 네트워크에 공개되지 않은 네트워크(우리가 사용하는 모든 네트워크 기기의 IP 주소)
    - 사설 IP 주소의 할당 주체는 라우터
    - 할당받은 사설 IP 주소는 해당 호스트가 속한 사설 네트워크상에서만 유효한 주소이므로, 얼마든지 다른 네트워크상의 사설 IP 주소와 중복이 가능<br><br>

3. NAT(Network Address Translation)
    - 사설 IP 주소를 사용하는 호스트가 외부 네트워크와 통신하기 위해 사용되는 기술
    - 네트워크 내부에서 사용된는 사설 IP 주소와 네트워크 외부에서 사용되는 공인 IP 주소를 변환하는 데 사용되는 기술<br><br>

## 7. 호스트에 IP 주소 할당 방법
1. 정적 할당
    - 호스트에 직업 수작업으로 IP 주소를 부여하는 방식<br><br>

2. 동적 할당
    - 정적 할당과 달리 IP 주소를 직접 일일이 입력하지 않아도 호스트에 IP 주소가 동적으로 할당되는 방식
    - 사용되지 않을 경우 회수되고, 할당받을 때마다 다른 주소를 할당받음<br><br>

3. DHCP(Dynamic Host Configuration Protocol)
    - IP 동적 할당에 사용되는 대표적인 프로토콜
    - IP 주소 할당을 IP 주소를 할당받고자 하는 호스트(클라이언트)와 해당 호스트에게 IP 주소를 제공하는 DHCP 서버 간의 메시지를 주고받음으로써 이루어짐
    - DHCP로 할당받은 IP 주소는 사용할 기간(임대 기간)이 정해져 있음<br><br>

## 8. 라우팅
1. 라우팅이란
    - 패킷이 이동할 최적의 경로를 설정한 뒤 해당 경로로 패킷을 이동시키는 것<br><br>

2. 홉(hop)
    - 라우팅 도중 패킷이 호스트와 라우터 간에, 혹은 라우터와 라우터 간에 이동하는 하나의 과정
    - 즉, 패킷은 '여러 홉을 거쳐' 라우팅될 수 있는 것<br><br>

## 9. 라우팅 테이블
1. 라우팅 테이블이란
    - 특정 수신지까지 도달하기 위한 정보를 명시한 일종의 표와 같은 정보
    - 라우터는 라우팅 테이블을 참고하여 수신지까지의 도달 경로를 판단<br><br>

2. 라우팅 테이블 정보
    - 수신지 IP 주소와 서브넷 마스크 : 최종적으로 패킷을 전달할 대상
    - 다음 홉 : 최종 수신지까지 가기 위해 다음으로 거쳐야 할 호스트의 IP 주소나 인터페이스 = 게이트웨이
    - 네트워크 인터페이스 : 패킷을 내보낼 통로
    - 메트릭 : 해당 경로로 이동하는 데 드는 비용<br><br>

3. 디폴트 라우트
    - 라우팅 테이블에 없는 경로로 패킷을 전송해야 하는 경우, 기본적으로 패킷을 내보낼 수 있도록 설정한 기본 경로
    - 모든 IP 주소를 의미하는 0.0.0.0/0으로 명시<br><br>

4. 라우팅 테이블을 만드는 방법
    - 정적 라우팅
        - 수동으로 채워진 라우팅 테이블을 토대로 라우팅되는 방식
    - 동적 라우팅
        - 라우팅 프로토콜을 통해 자동으로 채워진 라우팅 테이블을 토대로 라우팅되는 방식
        - 모든 라우터는 특정 수신지까지 도달하기 위한 최적의 경로를 찾아 라우팅 테이블에 추가하기 위해 라우팅끼리 서로 자신의 정보를 교환하는 과정에서 (동적)라우팅 프로토콜을 사용<br><br>

## 10. 라우터들의 집단 네트워크 AS(Autonomous System)
1. AS란
    - 동일한 라우팅 정책으로 관리되는 라우터들의 집단 네트워크
    - 한 회사나 단체에서 관리하는 라우터 집단
    - 인터넷상에서 AS 번호인 ASN이 고유하게 할당됨<br><br>

2. AS 경계 라우터(ASBR, Autonomous System Boundary Router)
    - 한 AS 내에는 다수의 라우터가 존재하며, 라우터들은 AS 외부에서 통신할 수 있음
    - AS 외부와 통신할 경우 AS 경계에서 AS 내외로 통신을 주고받을 수 있도록 해주는 라우터<br><br>

## 11. 라우팅 프로토콜
1. 라우팅 프로토콜이란
    - 라우터끼리 자신들의 정보를 교환하며 패킷이 이동할 최적의 경로를 찾기 위한 프로토콜<br><br>

2. 라우팅 프로토콜 종류
    - IGP(Interior Gateway Protocol) : AS 내부에서 수행되는 프로토콜
        - RIP(Routing Information Protocol) : 거리 벡터 기반의 라우팅 프로토콜
            - 거리를 기반으로 최적의 경로를 찾음
            - 거리는 패킷이 경유한 라우터의 수, 즉 홉의 수를 의미
            - 인접한 라우터끼리 경로 정보를 주기적으로 교환하며 라우팅 테이블을 갱신하여 라우터는 특정 수신지에 도달하기까지의 홉 수를 알 수 있음
            - 홉 수가 가장 적은 경로를 최적의 경로라 판단하며, 홉 수가 적을수록 메트릭 값도 작아짐
        - OSPF(Open Shortest Path First) : 링크 상태 기반의 라우팅 프로토콜
            - 링크 정보(그래프 형태로 이루어진 네트워크의 노드와 간선 중에서 간선을 의미)를 비롯한 현재 네트워크의 상태를 그래프의 형태로 링크 상태 데이터베이스(LSDB, Link State DataBase)에 저장
                - 링크 상태 데이터베이스에는 라우터들의 연결 관계, 연결 비용 등 현재 네트워크의 상태를 그래프로 표현하기 위한 데이터가 저장
            - 라우터는 링크 상태 데이터베이스를 기반으로 현재 네트워크 구성을 지도처럼 그린 뒤 최적의 경로를 선택
                - 최적의 경로를 결정하기 위해 대역폭을 기반으로 메트릭을 계산하며, 대역폭이 높은 링크일수록 메트릭이 낮은 경로로 인식
            - 네트워크의 구성이 변경되었을 때 라우팅 테이블이 갱신됨
                - AS를 에어리어(area)라는 단위로 나누고, 구분된 에어리어 내에서만 링크 상태를 공유
                - 에어리어에는 번호가 부여되어 있으며, 에어리어 경계에 있는 ABR(Area Border Router)가 에어리어 간의 연결을 담당
        - EIGRP(Enhanced Interior Gateway Routing Protocol) : 고급 거리 벡터 프로토콜과 링크 상태 프로토콜의 성격을 모두 띠는 라우팅 프로토콜
    - EGP(Exterior Gateway Protocol) : AS 외부에서 수행되는 프로토콜
        - BGP(Border Gateway Protocol) : AS 간과 AS 내 라우터 간의 통신이 가능한 프로토콜
            - AS 간의 통신을 위한 eBGP(external BGP)와 AS 내의 통신을 위한 iBGP(internal BGP)로 구분
            - AS 간의 정보를 주고받기 위해 AS 내에서 eBGP를 사용하는 라우터(BGP)가 하나 이상 있어야 하고, 또 다른 AS의 BGP 라우터와 연결되어야 함
                - 이 연결은 BGP 라우터 간에 BGP 메시지를 주고받음으로써 이루어지며, BGP 메시지를 주고 받을 수 있도록 연결된 BGP 라우터를 피어(peer)라고 함
                - 다른 AS와의 BGP 연결을 유지하기 위해 BGP 라우터끼리 연결되어 피어가 되어야 하고, 피어 관계가 되도록 연결되는 과정을 피어링(peering)이라 함
            - 경로 결정 과정에서 수신지 주소와 더불어 다양한 속성과 정책이 고려되어 최적의 경로를 결정하는 과정이 복잡하고 일정하지 않음
            - BGP 속성
                - AS-PATH 속성 : 메시지가 수신지에 이르는 과정에서 통과하는 AS들의 목록
                    - 메시지가 AS를 거칠 때마다 AS-PATH에는 거쳐 간 AS가 추가됨
                    - AS-PATH 속성을 통한 BGP(eBGP)의 두 가지 특징
                        - 첫째, BGP는 AS 간 라우팅을 할 때 거치게 될 라우터의 수가 아닌 AS의 수를 고려함
                        - 둘째, BGP는 RIP처럼 단순히 수신지에 이르는 거리가 아닌, 메시지가 어디를 거쳐 어디로 이동하는지를 나타내는 경로를 고려함
                            - 이런 점에서 BGP는 경로 벡터 라우팅 프로토콜의 일종이라 부르기도 함
                - NEXT-HOP 속성 : 다음 홉, 다음으로 거칠 라우터의 IP 주소
                - LOCAL-PREF(preference) 속성 : AS 외부 경로에 있어 AS 내부에서(local) 어떤 경로를 선호할지에 대한 척도
                    - 경로를 선택하는 과정에서 LOCAL PREF 값은 일반적으로 다른 속성보다 우선시되며, 값이 클수록 우선으로 선택됨
                    - LOCAL PREF 값은 AS 관리 주체가 설정하는 정책의 영향을 받아 선택한 경로가 다른 경로에 비해 비교적 비효율적이라도 해당 경로를 우선시 할 수 있음